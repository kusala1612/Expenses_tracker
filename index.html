<!DOCTYPE html>
<html>
<head>
  <title>Expense Manager Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* --- General body and container --- */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(to right, #74ebd5, #ACB6E5);
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 1000px;
        margin: 30px auto;
        background: #fff;
        padding: 25px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    h1, h2 {
        text-align: center;
        color: #2c3e50;
    }

    input, button {
        padding: 10px 15px;
        margin: 8px 5px;
        border-radius: 8px;
        border: 1px solid #ccc;
        outline: none;
        font-size: 16px;
    }

    button {
        background: #3498db;
        color: #fff;
        border: none;
        cursor: pointer;
        transition: 0.3s;
    }

    button:hover { background: #2980b9; }

    .section { margin-bottom: 35px; }

    table { width:100%; border-collapse:collapse; margin-top: 15px; font-size:16px; }
    th, td { border:1px solid #ddd; padding:12px; text-align:center; }
    th { background: linear-gradient(to right, #3498db, #2980b9); color:#fff; font-weight:bold; }
    tr:nth-child(even) { background: #f1f1f1; }

    .total { font-weight:bold; font-size:1.3em; text-align:center; color:#e74c3c; margin-top:10px; }
    canvas { margin-top:20px; border-radius:10px; background:#fafafa; padding:10px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }

    #loginPage, #registerPage {
        max-width: 400px;
        margin: 80px auto;
        background: #fff;
        padding: 30px 25px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    #loginPage h1, #registerPage h1 { margin-bottom: 20px; }

    @media screen and (max-width: 768px) {
        .container { padding: 15px; margin: 20px; }
        table { font-size: 14px; }
        input, button { font-size: 14px; padding: 8px 12px; }
    }
  </style>
</head>
<body>

<!-- --- LOGIN PAGE --- -->
<div class="container" id="loginPage">
  <h1>Expense Manager Login</h1>
  <input type="text" id="username" placeholder="Username"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button onclick="login()">Login</button>
  <button onclick="showRegister()">Register</button>
</div>

<!-- --- REGISTER PAGE --- -->
<div class="container" id="registerPage" style="display:none;">
  <h1>Register</h1>
  <input type="text" id="regUsername" placeholder="Username"><br>
  <input type="password" id="regPassword" placeholder="Password"><br>
  <button onclick="register()">Register</button>
  <button onclick="showLogin()">Back to Login</button>
</div>

<!-- --- DASHBOARD --- -->
<div class="container" id="dashboard" style="display:none;">
  <h1>Expense Manager Dashboard</h1>

  <!-- Add Expense -->
  <div class="section">
    <h2>Add Expense</h2>
    <input type="text" id="date" placeholder="DD-MM-YYYY">
    <input type="text" id="desc" placeholder="Description">
    <input type="number" id="amount" placeholder="Amount">
    <input type="text" id="category" placeholder="Category">
    <button onclick="addExpense()">Add Expense</button>
  </div>

  <!-- Total Expenses -->
  <div class="section">
    <h2>Total Expenses</h2>
    <button onclick="showTotal()">Show Total</button>
    <p id="total" class="total">0</p>
  </div>

  <!-- Total Between Dates -->
  <div class="section">
    <h2>Total Between Dates</h2>
    <input type="text" id="start" placeholder="Start Date DD-MM-YYYY">
    <input type="text" id="end" placeholder="End Date DD-MM-YYYY">
    <button onclick="showTotalBetween()">Calculate</button>
    <p id="totalBetween" class="total">0</p>
  </div>

  <!-- Expenses Table -->
  <div class="section">
    <h2>All Expenses</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Category</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="expenses"></tbody>
    </table>
  </div>

  <!-- Charts -->
  <div class="section">
    <h2>Monthly Expenses</h2>
    <canvas id="expenseChart"></canvas>
    <h2>Expenses by Category</h2>
    <canvas id="categoryChart"></canvas>
  </div>

  <div class="section">
    <button onclick="logout()">Logout</button>
  </div>
</div>

<script>
let USER_ID = null;
let expenseChart, categoryChart;
const BASE_API = "http://127.0.0.1:5000";

// --- Login/Register ---
function showRegister(){ document.getElementById("loginPage").style.display="none"; document.getElementById("registerPage").style.display="block"; }
function showLogin(){ document.getElementById("registerPage").style.display="none"; document.getElementById("loginPage").style.display="block"; }

function register(){
  const username=document.getElementById("regUsername").value;
  const password=document.getElementById("regPassword").value;
  fetch(`${BASE_API}/register`, {
    method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({username,password})
  }).then(res=>res.json()).then(data=>{
    alert(data.message);
    if(data.message=="User registered!") showLogin();
  });
}

function login(){
  const username=document.getElementById("username").value;
  const password=document.getElementById("password").value;
  fetch(`${BASE_API}/login`, {
    method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({username,password})
  }).then(res=>res.json()).then(data=>{
    if(data.user_id){
      USER_ID=data.user_id;
      document.getElementById("loginPage").style.display="none";
      document.getElementById("dashboard").style.display="block";
      fetchExpenses();
    } else { alert(data.message); }
  });
}

function logout(){
  USER_ID=null;
  document.getElementById("dashboard").style.display="none";
  document.getElementById("loginPage").style.display="block";
}

// --- Expenses ---
function fetchExpenses(){
  fetch(`${BASE_API}/expenses/${USER_ID}`).then(res=>res.json()).then(data=>{
    const tbody=document.getElementById("expenses"); tbody.innerHTML="";
    data.forEach(exp=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${exp.date}</td><td>${exp.description}</td><td>${exp.amount}</td><td>${exp.category}</td>
      <td><button onclick="deleteExpense(${exp.id})">Delete</button></td>`;
      tbody.appendChild(tr);
    });
    renderCharts(data);
  });
}

function addExpense(){
  const date=document.getElementById("date").value;
  const desc=document.getElementById("desc").value;
  const amount=parseFloat(document.getElementById("amount").value);
  const category=document.getElementById("category").value||"General";
  if(!date||!desc||isNaN(amount)){ alert("Fill all fields correctly."); return; }

  fetch(`${BASE_API}/expenses`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({user_id:USER_ID,date,description:desc,amount,category})
  }).then(()=>fetchExpenses());
}

function deleteExpense(id){
  fetch(`${BASE_API}/expenses/${USER_ID}/${id}`,{method:"DELETE"}).then(()=>fetchExpenses());
}

function showTotal(){
  fetch(`${BASE_API}/expenses/total/${USER_ID}`).then(res=>res.json()).then(data=>document.getElementById("total").textContent=data.total);
}

function showTotalBetween(){
  const start=document.getElementById("start").value;
  const end=document.getElementById("end").value;
  if(!start||!end){ alert("Enter start and end dates."); return; }
  fetch(`${BASE_API}/expenses/total_between/${USER_ID}`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body:JSON.stringify({start,end})
  }).then(res=>res.json()).then(data=>document.getElementById("totalBetween").textContent=data.total);
}

// --- Charts ---
function renderCharts(data){
  // Monthly chart
  const monthly={};
  data.forEach(exp=>{
    const d=new Date(exp.date); 
    const m=`${d.getFullYear()}-${d.getMonth()+1}`;
    monthly[m]=(monthly[m]||0)+exp.amount;
  });
  const labelsM=Object.keys(monthly).sort();
  const valuesM=labelsM.map(m=>monthly[m]);
  const ctxM=document.getElementById("expenseChart").getContext("2d");
  if(expenseChart) expenseChart.destroy();
  expenseChart=new Chart(ctxM,{
    type:'bar',
    data:{labels:labelsM,datasets:[{label:'Monthly Expenses',data:valuesM,backgroundColor:'rgba(52,152,219,0.7)',borderColor:'rgba(41,128,185,1)',borderWidth:1}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });

  // Category chart
  const categories={};
  data.forEach(exp=>{ categories[exp.category]=(categories[exp.category]||0)+exp.amount; });
  const labelsC=Object.keys(categories);
  const valuesC=labelsC.map(c=>categories[c]);
  const ctxC=document.getElementById("categoryChart").getContext("2d");
  if(categoryChart) categoryChart.destroy();
  categoryChart=new Chart(ctxC,{
    type:'pie',
    data:{labels:labelsC,datasets:[{label:'Expenses by Category',data:valuesC,backgroundColor:['#3498db','#e74c3c','#f1c40f','#2ecc71','#9b59b6','#34495e','#e67e22','#1abc9c']}]},
    options:{responsive:true,plugins:{legend:{position:'right'},title:{display:true,text:'Expenses by Category'}}}
  });
}
</script>
</body>
</html>
